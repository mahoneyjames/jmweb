<html><head><title>Notes on AS2 MDNs | James Mahoney</title><link rel="stylesheet" href="/style.css"/><link href="https://netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.min.css" rel="stylesheet"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta charset="UTF-8"/></head><body><header><div class="inner"> <h1><a href="/index.htm">James Mahoney</a></h1><nav><ul><li>                          <a href="/about.htm">about</a></li><li><a href="/index.htm">blog            </a></li></ul></nav></div></header><div class="wrapper"><main class="content"><div class="Container blogPost"><section class="info"><h1 class="title">Notes on AS2 MDNs</h1><p class="when">Jun 18th 2019    </p></section><div class="body"><p>The goto help for .NET developers wanting to send or receive AS2 without a third party library is <a href="https://mattfrear.com/2011/01/03/receiving-as2-messages-with-net/">this one</a></p>
<p>Unfortunately the detail about creating an MDN to return in response to receiving a file is somewhat lacking...</p>
<p>After a bit of toing and froing of deconstructing a real MDN generated by another RSS solution I managed to figure it out. </p>
<h1 id="mdn-overview">MDN overview</h1>
<p>A signed MDN is a multipart message made up of the following</p>
<ul>
<li>Message - multipart/signed<ul>
<li>Part 1 -  multipart/report<ul>
<li>Part a - text/plain - a human friendly response</li>
<li>Part a - message/disposition-notification - the actual response that the sending AS2 server can do something with</li>
</ul>
</li>
<li>Part 2 - application/pkcs7-signature<ul>
<li>Digital signature of the first part i.e. parts a and b</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="part-a"><em>Part a</em></h2>
<p>A human friendly string</p>
<pre><code>Content-Type: text/plain

A message of some kind. Something that would make sense to a human e.g. message with id &#39;blah&#39; sent from &#39;sender&#39; to &#39;recipient&#39; has been received and processed successfully
</code></pre><h2 id="part-b"><em>Part b</em></h2>
<p>A collection of data taking the form of HTTP headers</p>
<pre><code>Content-Type: message/disposition-notification

Original-Recipient: rfc822; mendelsontestAS2
Final-Recipient: rfc822; mendelsontestAS2
Original-Message-ID: &lt;AS2_024737Thu&gt;
Disposition: automatic-action/MDN-sent-automatically; processed
Received-Content-MIC: ztIqTMkKwPDxQRhvQajdHfOVx8A=, sha1
</code></pre><ul>
<li>Received-Content-MIC: this is the hash of the <em>original</em> message<ul>
<li>If the original message was signed then <em>only</em> hash the message portion, not the signature</li>
</ul>
</li>
</ul>
<h1 id="part-1">Part 1</h1>
<p>Combine part a and part b together!</p>
<p>A common convention is to use &quot;MDNBoundary&quot; as the multipart boundary</p>
<pre><code>--MDNBoundary
Content-Type: text/plain

The incoming message from ThirdPartyCompany to UnitTests with Id &lt;UnitTests-20190605-163049455-lIEj@ThirdPartyCompany_UnitTests&gt; was received successfully. This is not a guarantee that the message has been processed by the receiving translator.

--MDNBoundary
Content-Type: message/disposition-notification

Original-Recipient: rfc822;UnitTests
Final-Recipient: rfc822;UnitTests
Original-Message-ID: &lt;UnitTests-20190605-163049455-lIEj@ThirdPartyCompany_UnitTests&gt;
Disposition: automatic-action/MDN-sent-automatically; processed

--MDNBoundary--
</code></pre><h1 id="part-2">Part 2</h1>
<p>Generate a signature for Part 1</p>
<p>This involves hashing the contents of that first part i.e. start at --MDNBoundary and finish at --MDNBoundary--</p>
<p>Remember to include the trailing \r\n</p>
<pre><code>Content-Type: application/pkcs7-signature; name=&quot;smime.p7s&quot;
Content-Disposition:  attachment; filename=&quot;smime.p7s&quot;
Content-Transfer-Encoding: base64

MIIFNQYJKoZIhvcNAQcCoIIFJjCCBSICAQExCzAJBgUrDgMCGgUAMAsGCSqGSIb3DQEHAaCCA0Yw
ggNCMIICKqADAgECAhAEgxCDCl5FL5NapV+Kxn8gMA0GCSqGSIb3DQEBCwUAMB0xGzAZBgNVBAMT
EkRldmZ1c2lvblVuaXRUZXN0czAgFw0xOTA1MzAwODM4MDVaGA8yMTAyMDkzMDA4NDgwNVowHTEb
MBkGA1UEAxMSRGV2ZnVzaW9uVW5pdFRlc3RzMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKC
AQEAy2lr1pIqvGbQrZpUfP1HsVVt4I9IxKq4mKMJZ3uqMi5IiM/7UzQwiiXhOPQTg8Yn0LZTW+D+
efG0N8zWhWmWz4XWDjo/+cFxZrtKpEdizD1ZPtDQicMX0Zyumt9pcKdw+VDOGbPOTmM/JA1DaB2/
TBh+LTtOpcYp0Z+YVWfT8nC+12FqF6wC3SmE/C/FnpEKEg6L8sv/T4FHxpZZnuJ4I3/bqXKsmaCd
M5dImbcqpRjimoquQutCMi/s5i1hTbGq7Mqpqq1PgLCieYAy5DOKYpYQbkpZdTZBsr4ryS5z5olg
fh6bBLlHHxGWMwLMMx0sn/9q93GOTE8wCkhA3dui5QIDAQABo3wwejAOBgNVHQ8BAf8EBAMCBaAw
CQYDVR0TBAIwADAdBgNVHSUEFjAUBggrBgEFBQcDAQYIKwYBBQUHAwIwHwYDVR0jBBgwFoAUt+AL
fRABCUQtVgPSqpMQJCdYxuswHQYDVR0OBBYEFLfgC30QAQlELVYD0qqTECQnWMbrMA0GCSqGSIb3
DQEBCwUAA4IBAQAz7VST1StdPp0Z6DJIz4NSqJ6pWwvO3SZKv8k6IwVd5ltDA9Aw3eAlgjMCVR+x
CyaB90cqxexVmgas+xvgrf3QpW1/5RlAGQ5MP804Tgm1VO9B/JVn5xgSfNCpivv2n8rApFRAnRM8
ItFBFHaUPu4IeuegPIMQg1AeiHHFQqxQ+1AG3OwTUvHvKCNFhC1+dhAgUPX277tb+5UbSP0FKk7n
huF0Rp+MjbC+FRCyPLAMhBz+HuCUtpT3IEBB33mh3WTq8yViRiq6Ccm5W0ovFL56Dqb4gLwAUwg1
eiauoITdk9qeOyk2dzvzyfbsHjqG+sCYLWVxjoI3HfU/f5/W3lCPMYIBtzCCAbMCAQEwMTAdMRsw
GQYDVQQDExJEZXZmdXNpb25Vbml0VGVzdHMCEASDEIMKXkUvk1qlX4rGfyAwCQYFKw4DAhoFAKBd
MBgGCSqGSIb3DQEJAzELBgkqhkiG9w0BBwEwHAYJKoZIhvcNAQkFMQ8XDTE5MDYwNTE1MzA1MFow
IwYJKoZIhvcNAQkEMRYEFI5sPRPBcHqkVpCvMJexDAcssa2hMA0GCSqGSIb3DQEBAQUABIIBAFGb
cJmSxiPj0BgvSXUswCYUH5rA6eQAVXt8cLdRhAwaGqGpEoa13OQojF5mkU8Kql8q1gXPRlmG71dV
pT1ysgN26CNssOM21MsUMLCQuD2PQ1yJLXERbNw4K9vUwDga3U+H6YpsW4REclxhVUoaJm2EoQ+G
upuicCALP9lc80NtFr2vPYenBr7E2Yv64IqQX0jb8u8OMtkpCnojXtEuRhcUHfxhDjBRq2SJ9cKC
kexKFEm6IgvYWMrdlObSTuXo5zdAp3HJQIpmk8kFwDeECxiCe5o6UCE44PATmzREyYO0CYw3SXNF
qUZ3l86qxJO1V4jGxXto71WdXMxEiUNlPHA=
</code></pre><h1 id="message">Message</h1>
<p>Join parts 1 and 2 together using <em>another</em> multipart boundary marker</p>
<pre><code>
--80edd8a5-c53b-499d-8929-61a027d449d5
Content-Type: multipart/report; report-type=disposition-notification; boundary=&quot;MDNBoundary&quot;
Content-Transfer-Encoding: 8bit


--MDNBoundary
Content-Type: text/plain

The incoming message from ThirdPartyCompany to UnitTests with Id &lt;UnitTests-20190605-163049455-lIEj@ThirdPartyCompany_UnitTests&gt; was received successfully. This is not a guarantee that the message has been processed by the receiving translator.

--MDNBoundary
Content-Type: message/disposition-notification

Original-Recipient: rfc822; mendelsontestAS2
Final-Recipient: rfc822; mendelsontestAS2
Original-Message-ID: &lt;AS2_024737Thu&gt;
Disposition: automatic-action/MDN-sent-automatically; processed
Received-Content-MIC: ztIqTMkKwPDxQRhvQajdHfOVx8A=, sha1

--MDNBoundary--

--80edd8a5-c53b-499d-8929-61a027d449d5
Content-Type: application/pkcs7-signature; name=&quot;smime.p7s&quot;
Content-Disposition:  attachment; filename=&quot;smime.p7s&quot;
Content-Transfer-Encoding: base64

MIIFNQYJKoZIhvcNAQcCoIIFJjCCBSICAQExCzAJBgUrDgMCGgUAMAsGCSqGSIb3DQEHAaCCA0Yw
ggNCMIICKqADAgECAhAEgxCDCl5FL5NapV+Kxn8gMA0GCSqGSIb3DQEBCwUAMB0xGzAZBgNVBAMT
EkRldmZ1c2lvblVuaXRUZXN0czAgFw0xOTA1MzAwODM4MDVaGA8yMTAyMDkzMDA4NDgwNVowHTEb
MBkGA1UEAxMSRGV2ZnVzaW9uVW5pdFRlc3RzMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKC
AQEAy2lr1pIqvGbQrZpUfP1HsVVt4I9IxKq4mKMJZ3uqMi5IiM/7UzQwiiXhOPQTg8Yn0LZTW+D+
efG0N8zWhWmWz4XWDjo/+cFxZrtKpEdizD1ZPtDQicMX0Zyumt9pcKdw+VDOGbPOTmM/JA1DaB2/
TBh+LTtOpcYp0Z+YVWfT8nC+12FqF6wC3SmE/C/FnpEKEg6L8sv/T4FHxpZZnuJ4I3/bqXKsmaCd
M5dImbcqpRjimoquQutCMi/s5i1hTbGq7Mqpqq1PgLCieYAy5DOKYpYQbkpZdTZBsr4ryS5z5olg
fh6bBLlHHxGWMwLMMx0sn/9q93GOTE8wCkhA3dui5QIDAQABo3wwejAOBgNVHQ8BAf8EBAMCBaAw
CQYDVR0TBAIwADAdBgNVHSUEFjAUBggrBgEFBQcDAQYIKwYBBQUHAwIwHwYDVR0jBBgwFoAUt+AL
fRABCUQtVgPSqpMQJCdYxuswHQYDVR0OBBYEFLfgC30QAQlELVYD0qqTECQnWMbrMA0GCSqGSIb3
DQEBCwUAA4IBAQAz7VST1StdPp0Z6DJIz4NSqJ6pWwvO3SZKv8k6IwVd5ltDA9Aw3eAlgjMCVR+x
CyaB90cqxexVmgas+xvgrf3QpW1/5RlAGQ5MP804Tgm1VO9B/JVn5xgSfNCpivv2n8rApFRAnRM8
ItFBFHaUPu4IeuegPIMQg1AeiHHFQqxQ+1AG3OwTUvHvKCNFhC1+dhAgUPX277tb+5UbSP0FKk7n
huF0Rp+MjbC+FRCyPLAMhBz+HuCUtpT3IEBB33mh3WTq8yViRiq6Ccm5W0ovFL56Dqb4gLwAUwg1
eiauoITdk9qeOyk2dzvzyfbsHjqG+sCYLWVxjoI3HfU/f5/W3lCPMYIBtzCCAbMCAQEwMTAdMRsw
GQYDVQQDExJEZXZmdXNpb25Vbml0VGVzdHMCEASDEIMKXkUvk1qlX4rGfyAwCQYFKw4DAhoFAKBd
MBgGCSqGSIb3DQEJAzELBgkqhkiG9w0BBwEwHAYJKoZIhvcNAQkFMQ8XDTE5MDYwNTE1MzA1MFow
IwYJKoZIhvcNAQkEMRYEFI5sPRPBcHqkVpCvMJexDAcssa2hMA0GCSqGSIb3DQEBAQUABIIBAFGb
cJmSxiPj0BgvSXUswCYUH5rA6eQAVXt8cLdRhAwaGqGpEoa13OQojF5mkU8Kql8q1gXPRlmG71dV
pT1ysgN26CNssOM21MsUMLCQuD2PQ1yJLXERbNw4K9vUwDga3U+H6YpsW4REclxhVUoaJm2EoQ+G
upuicCALP9lc80NtFr2vPYenBr7E2Yv64IqQX0jb8u8OMtkpCnojXtEuRhcUHfxhDjBRq2SJ9cKC
kexKFEm6IgvYWMrdlObSTuXo5zdAp3HJQIpmk8kFwDeECxiCe5o6UCE44PATmzREyYO0CYw3SXNF
qUZ3l86qxJO1V4jGxXto71WdXMxEiUNlPHA=

--80edd8a5-c53b-499d-8929-61a027d449d5--

</code></pre></div></div></main></div></body></html>